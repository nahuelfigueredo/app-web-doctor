<script>
  // ...resto del script...

  async function actualizarEstadoTurno(id, estado) {
  if (!token) {
    console.log('Sin token, no actualizo turno');
    return;
  }

  console.log('actualizarEstadoTurno llamado con:', { id, estado });

  try {
    const res = await fetch(`/api/turnos/${id}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ estado })
    });

    console.log('Respuesta PATCH /api/turnos/:id status:', res.status);

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      console.error('Error al actualizar turno:', res.status, errorData);
      throw new Error(errorData.error || 'Error al actualizar el estado del turno');
    }

    const turnoActualizado = await res.json();
    console.log('Turno actualizado:', turnoActualizado);

    // Actualizar array en memoria
    const idx = todosLosTurnos.findIndex(t => String(t.id) === String(id));
    if (idx !== -1) {
      todosLosTurnos[idx].estado = turnoActualizado.estado;
    }

    renderTurnos();

    // --- WhatsApp según el nuevo estado ---
    const telRaw = (turnoActualizado.telefono || '').replace(/[^0-9]/g, '');
    console.log('telRaw:', telRaw, 'estado recibido:', estado);

    // Solo mandamos WhatsApp si hay teléfono y el nuevo estado es confirmado o cancelado
    if (telRaw && (estado === 'confirmado' || estado === 'cancelado')) {
      const telefonoWhatsApp = `549${telRaw}`;
      console.log('telefonoWhatsApp final:', telefonoWhatsApp);

      let texto = '';
      if (estado === 'confirmado') {
        texto =
          `Hola ${turnoActualizado.nombre || ''}, tu turno con la Dra. Zuchelli ha sido CONFIRMADO.\n\n` +
          `Fecha: ${turnoActualizado.fecha}\n` +
          `Hora: ${turnoActualizado.hora}\n\n` +
          `Si no podés asistir, por favor avisar.`;
      } else if (estado === 'cancelado') {
        texto =
          `Hola ${turnoActualizado.nombre || ''}, te informamos que tu turno con la Dra. Zuchelli ha sido CANCELADO.\n\n` +
          `Fecha: ${turnoActualizado.fecha}\n` +
          `Hora: ${turnoActualizado.hora}\n\n` +
          `Por favor, comunicate para reprogramar.`;
      }

      if (texto) {
        const url = `https://wa.me/${telefonoWhatsApp}?text=${encodeURIComponent(texto)}`;
        console.log('Abriendo WhatsApp con URL:', url);
        window.open(url, '_blank');
      } else {
        console.log('No hay texto para WhatsApp, no se abre ventana.');
      }
    } else {
      console.log('No se envía WhatsApp. Motivo:',
        telRaw ? `estado no es confirmado/cancelado (${estado})` : 'no hay teléfono válido');
    }
    // --- fin WhatsApp ---

  } catch (error) {
    console.error(error);
    alert(error.message || 'No se pudo actualizar el estado del turno.');
  }
}
      

  // ...resto del script...
</script>